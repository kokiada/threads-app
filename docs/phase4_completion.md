# Phase 4: スケジューラー実装 完了報告

## 実装日
2025年1月

## 実装内容

### 1. APScheduler設定
- **ファイル**: `threads/scheduler/scheduler.py`
- BackgroundSchedulerの初期化
- SQLAlchemyJobStoreの設定（永続化対応）
- ThreadPoolExecutorの設定（最大20スレッド）

### 2. スケジュールジョブ

#### execute_scheduled_post
- アカウントとスケジュールの取得
- アカウントに紐づくグループからランダム選択
- 非同期投稿の実行
- エラーハンドリング

#### token_refresh_job
- 毎日午前3時に実行
- 有効期限7日以内のトークンを自動リフレッシュ
- TokenServiceを使用

#### schedule_random_posts
- ランダム時刻の生成（開始時刻〜終了時刻の範囲内）
- 指定回数分のランダム投稿をスケジュール
- 日付をまたぐ時刻範囲にも対応

### 3. スケジューラー管理

#### start_scheduler
- スケジューラーの起動
- トークンリフレッシュジョブの登録
- アクティブなスケジュールの読み込み
- Reflexアプリ起動時に自動実行

#### stop_scheduler
- スケジューラーの停止

#### reload_schedules
- 既存のスケジュールジョブを削除
- アクティブなスケジュールを再取得
- 固定時刻スケジュールの登録（cron）
- ランダム時刻スケジュールの登録

### 4. サービス層の拡張

#### PostGroupService
- `get_groups_by_account`メソッドを追加
- アカウントに紐づくグループを取得

### 5. Reflexアプリとの統合
- `threads/threads.py`にスケジューラー起動処理を追加
- アプリ起動時に自動的にスケジューラーが開始

### 6. テストスクリプト
- **ファイル**: `scripts/test_scheduler.py`
- スケジューラーの初期化確認
- ジョブ登録の確認
- アクティブなスケジュールの表示

## 動作確認

### テスト実行結果
```
=== スケジューラーテスト ===

1. スケジューラー初期化...
   ✓ スケジューラー作成: <BackgroundScheduler>

2. スケジューラー起動...
   ✓ 実行中: True

3. 登録済みジョブ:
   - schedule_1_20:00: 2025-10-22 20:00:00+09:00
   - token_refresh: 2025-10-23 03:00:00+09:00
   - schedule_1_10:00: 2025-10-23 10:00:00+09:00
   - schedule_1_15:00: 2025-10-23 15:00:00+09:00

4. アクティブなスケジュール:
   - Schedule ID: 1
     Account: テストアカウント
     Type: FIXED
     Times: ['10:00', '15:00', '20:00']

5. スケジューラー停止...
   ✓ 停止完了

=== テスト完了 ===
```

## 主要機能

### 固定時刻スケジュール
- 指定した時刻に自動投稿
- 複数の時刻を設定可能
- cronジョブとして登録

### ランダム時刻スケジュール
- 開始時刻〜終了時刻の範囲内でランダムに投稿
- 投稿回数を指定可能
- 毎日異なる時刻に投稿

### トークン自動リフレッシュ
- 毎日午前3時に実行
- 有効期限7日以内のトークンを自動更新
- アカウント単位で処理

### スケジュール再読み込み
- スケジュール変更時に動的に反映
- 既存ジョブの削除と再登録
- ダウンタイムなしで更新

## 技術的な特徴

### 永続化
- SQLAlchemyJobStoreを使用
- アプリ再起動後もジョブが保持される
- データベースと統合

### 非同期処理
- asyncioを使用した投稿処理
- 30秒待機（画像/動画の場合）
- エラーハンドリング

### エラー処理
- データベース接続のクリーンアップ
- アカウント状態の確認
- グループ存在チェック

## 次のステップ

Phase 4完了により、以下が可能になりました：
- ✅ 自動投稿機能
- ✅ トークン自動更新
- ✅ スケジュール管理

次の実装候補：
1. **Phase 5 追加実装**（推奨）
   - スケジュール設定ページの詳細実装
   - 手動投稿ページの実装
   - メトリクス分析ページの実装

2. **Phase 6: エラーハンドリング・ロギング**
   - グローバルエラーハンドラー
   - UI側のエラー表示
   - ロギング設定

## 使用方法

### スケジューラーの起動
```python
from threads.scheduler import start_scheduler
start_scheduler()
```

### スケジューラーの停止
```python
from threads.scheduler import stop_scheduler
stop_scheduler()
```

### スケジュールの再読み込み
```python
from threads.scheduler import reload_schedules
reload_schedules()
```

### テスト実行
```bash
/home/koki/work/threads/venv/bin/python scripts/test_scheduler.py
```

## 注意事項

1. **データベース接続**: スケジューラーは独自のDB接続を管理
2. **タイムゾーン**: システムのタイムゾーンを使用
3. **ジョブID**: `schedule_{id}_{time}` 形式で一意に管理
4. **再起動**: Reflexアプリ再起動時に自動的にスケジューラーも起動

## 完了確認

- [x] APSchedulerの設定完了
- [x] 固定時刻スケジュール実装
- [x] ランダム時刻スケジュール実装
- [x] トークンリフレッシュジョブ実装
- [x] スケジューラー管理機能実装
- [x] Reflexアプリとの統合
- [x] テストスクリプト作成
- [x] 動作確認完了
