# Threads自動投稿WebApp 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Threads Auto Poster

### 1.2 目的
Threads公式APIを使用して、複数アカウントの投稿を効率的に管理・自動化するWebアプリケーション

### 1.3 対象ユーザー
- 複数のThreadsアカウントを運用する個人・企業
- 定期的な投稿を自動化したいコンテンツクリエイター

### 1.4 技術スタック
- **言語**: Python
- **フレームワーク**: Reflex
- **データベース**: SQLite（初期）→ PostgreSQL（本番移行時）
- **スケジューラー**: APScheduler
- **デプロイ**: Railway（推奨）/ Render / Fly.io

---

## 2. 機能要件

### 2.1 アカウント管理機能

#### 2.1.1 基本機能
- アカウントの追加・編集・削除
- 100以上のアカウント管理に対応
- アカウント情報の保存（DB）
  - アカウント名
  - Threads User ID
  - アクセストークン（暗号化保存）
  - トークン有効期限
  - 最終投稿日時
  - ステータス（有効/無効）

#### 2.1.2 トークン管理
- 長期トークン（60日間有効）の自動リフレッシュ
- トークン有効期限の監視・通知
- トークン失効時のエラーハンドリング

### 2.2 投稿管理機能

#### 2.2.1 投稿グループ管理
- グループ名を付けて投稿テンプレートを管理
- グループとアカウントの紐付け（1グループ → 複数アカウント）
- グループ内の投稿リスト管理
  - テキスト投稿
  - 画像投稿（URL指定）
  - 動画投稿（URL指定）
  - カルーセル投稿

#### 2.2.2 投稿タイプ
- **単一ユーザー・単一投稿**: 指定アカウントで1件投稿
- **単一ユーザー・ランダム投稿**: 指定アカウントで投稿リストからランダム選択
- **複数ユーザー・一括投稿**: 複数アカウントで同一内容を一括投稿
- **複数ユーザー・ランダム自動投稿**: 各アカウントがスケジュールに従ってランダム投稿

#### 2.2.3 投稿仕様
- テキスト: 最大500文字
- 画像: JPEG/PNG、最大8MB、最大幅1440px
- 動画: MOV/MP4、最大1GB、最大5分
- カルーセル: 2-20枚

### 2.3 スケジューリング機能

#### 2.3.1 スケジュール設定
- **固定時刻投稿**: 複数時刻設定可能（例: 10:00, 15:00, 20:00）
- **ランダム時刻投稿**: 時間帯範囲指定（例: 9:00-18:00の間で1日3回ランダム）
- アカウントごとに異なるスケジュール設定可能
- スケジュールの有効/無効切り替え

#### 2.3.2 投稿制御
- 自動投稿の開始・停止（アカウント単位）
- 投稿の重複許可（同じ投稿を複数回投稿可能）
- レート制限の監視（250件/24時間）

### 2.4 メトリクス分析機能

#### 2.4.1 投稿別パフォーマンス
- 各投稿の詳細メトリクス表示
  - いいね数
  - 返信数
  - リポスト数
  - 引用数
  - 表示回数
  - シェア数
- 投稿一覧でのソート・フィルタリング

#### 2.4.2 アカウント別集計
- アカウントごとの総合パフォーマンス
  - 期間指定（since/until）
  - 総いいね数
  - 総返信数
  - 総リポスト数
  - プロフィール閲覧数
  - フォロワー数
  - URLクリック数

#### 2.4.3 時系列グラフ
- プロフィール閲覧数の推移
- フォロワー数の推移
- エンゲージメント率の推移

#### 2.4.4 成長分析
- アカウント成長率ランキング
- フォロワー増加数（期間比較）
- エンゲージメント率の変化
- 伸びているアカウントのハイライト表示

---

## 3. 非機能要件

### 3.1 パフォーマンス
- 100アカウント以上の同時管理
- スケジュール投稿の正確な実行（±1分以内）
- メトリクス取得の非同期処理

### 3.2 セキュリティ
- アクセストークンの暗号化保存
- client_secretのサーバーサイド管理
- 将来的なログイン機能の実装を考慮した設計

### 3.3 可用性
- 24時間365日稼働（クラウドデプロイ時）
- エラー発生時の自動リトライ（指数関数的バックオフ）
- トークン失効時の通知機能

### 3.4 拡張性
- 将来的な認証機能追加を考慮
- PostgreSQLへの移行を考慮したDB設計
- 新しいメトリクスへの対応

---

## 4. システム構成

### 4.1 アーキテクチャ
```
[Reflex WebApp]
    ├── フロントエンド（UI）
    │   ├── アカウント管理画面
    │   ├── 投稿管理画面
    │   ├── スケジュール設定画面
    │   └── メトリクス分析画面
    │
    ├── バックエンド（API）
    │   ├── Threads API連携
    │   ├── DB操作
    │   └── ビジネスロジック
    │
    └── スケジューラー（APScheduler）
        ├── 自動投稿実行
        ├── トークンリフレッシュ
        └── メトリクス取得

[データベース（SQLite/PostgreSQL）]
    ├── accounts（アカウント情報）
    ├── post_groups（投稿グループ）
    ├── posts（投稿テンプレート）
    ├── schedules（スケジュール設定）
    ├── post_history（投稿履歴）
    └── metrics（メトリクスキャッシュ）
```

### 4.2 データベース設計（概要）

#### accounts
- id (PK)
- name
- threads_user_id
- access_token (encrypted)
- token_expires_at
- status
- created_at
- updated_at

#### post_groups
- id (PK)
- name
- description
- created_at
- updated_at

#### posts
- id (PK)
- group_id (FK)
- media_type (TEXT/IMAGE/VIDEO/CAROUSEL)
- text
- media_urls (JSON)
- created_at
- updated_at

#### account_groups
- account_id (FK)
- group_id (FK)

#### schedules
- id (PK)
- account_id (FK)
- schedule_type (FIXED/RANDOM)
- fixed_times (JSON)
- random_start_time
- random_end_time
- random_count
- is_active
- created_at
- updated_at

#### post_history
- id (PK)
- account_id (FK)
- post_id (FK)
- threads_media_id
- posted_at
- status

#### metrics_cache
- id (PK)
- account_id (FK)
- threads_media_id (nullable)
- metric_type
- metric_data (JSON)
- fetched_at

---

## 5. UI/UX要件

### 5.1 レイアウト
- サイドメニュー方式
- レスポンシブデザイン
- モダンなUI（Reflexの標準コンポーネント活用）

### 5.2 主要画面
1. **ダッシュボード**: 全体サマリー、成長アカウントハイライト
2. **アカウント管理**: アカウント一覧、追加・編集・削除
3. **投稿管理**: グループ管理、投稿テンプレート編集
4. **スケジュール設定**: アカウント別スケジュール設定
5. **手動投稿**: 単一/一括投稿実行
6. **メトリクス分析**: グラフ・表形式での分析表示

---

## 6. API連携仕様

### 6.1 使用エンドポイント
- `POST /{threads-user-id}/threads` - メディアコンテナ作成
- `POST /{threads-user-id}/threads_publish` - 投稿公開
- `GET /{threads-user-id}/threads` - 投稿一覧取得
- `GET /{threads-media-id}/insights` - 投稿メトリクス取得
- `GET /{threads-user-id}/threads_insights` - ユーザーメトリクス取得
- `GET /refresh_access_token` - トークンリフレッシュ
- `GET /{threads-user-id}/threads_publishing_limit` - レート制限確認

### 6.2 レート制限対応
- APIコール数: 4800 × インプレッション数
- 投稿制限: 250件/24時間
- クォータ監視の定期実行
- 制限超過時のキューイング

---

## 7. デプロイ要件

### 7.1 デプロイ先
- **推奨**: Railway（無料枠: 月500時間、DB込み）
- **代替**: Render（無料枠: スリープあり）、Fly.io

### 7.2 環境変数
- `DATABASE_URL`
- `ENCRYPTION_KEY`（トークン暗号化用）
- `THREADS_APP_ID`
- `THREADS_APP_SECRET`

---

## 8. 開発フェーズ

### Phase 1: 基本機能（MVP）
- アカウント管理（CRUD）
- 投稿グループ管理
- 単一投稿機能
- 基本的なスケジューリング

### Phase 2: 自動化機能
- ランダム投稿
- 複数アカウント一括投稿
- トークン自動リフレッシュ

### Phase 3: 分析機能
- メトリクス取得・表示
- 時系列グラフ
- 成長分析

### Phase 4: 拡張機能
- ログイン機能
- PostgreSQL移行
- 高度なスケジューリング

---

## 9. 制約事項

### 9.1 Threads API制約
- 投稿: 250件/24時間
- テキスト: 最大500文字
- 動画: 最大5分、1GB
- メディアファイルは公開サーバーにホスト必須

### 9.2 技術的制約
- 初期はログイン機能なし（ローカル/単一ユーザー想定）
- 画像/動画のアップロード機能なし（URL指定のみ）
- 投稿履歴の詳細保存なし（メトリクスはAPI経由で取得）

---

## 10. 今後の拡張可能性

- ユーザー認証・マルチテナント対応
- 画像/動画の直接アップロード機能
- AI活用の投稿文生成
- A/Bテスト機能
- より高度な分析（エンゲージメント予測等）
- Webhook連携
- 他SNSとの連携

---

## 11. 参考資料

- [Threads API公式ドキュメント](https://developers.facebook.com/docs/threads)
- [Reflex公式ドキュメント](https://reflex.dev)
- [APScheduler公式ドキュメント](https://apscheduler.readthedocs.io/)

---

**作成日**: 2025年1月
**バージョン**: 1.0
